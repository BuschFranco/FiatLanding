---
import { WHATSAPP_PHONE } from "../config";
import { planes } from "../data/planes";
const { defaultModel = "" } = Astro.props;
---
<section id="contacto" class="section">
  <div class="container contact-wrap">
    <h2 class="section-title">Contacto</h2>
    <form class="contact-form">
      <div class="form-grid">
        <input name="nombre" type="text" placeholder="Nombre y Apellido" style="padding:12px;border:1px solid var(--border);border-radius:8px" />
        <div class="phone-row" style="display:flex;gap:8px;align-items:center">
          <select name="codigoPais" style="padding:12px;border:1px solid var(--border);border-radius:8px;width:90px">
            <option value="+54">ðŸ‡¦ðŸ‡· +54</option>
            <option value="+598">ðŸ‡ºðŸ‡¾ +598</option>
            <option value="+56">ðŸ‡¨ðŸ‡± +56</option>
            <option value="+57">ðŸ‡¨ðŸ‡´ +57</option>
            <option value="+51">ðŸ‡µðŸ‡ª +51</option>
            <option value="+52">ðŸ‡²ðŸ‡½ +52</option>
            <option value="+55">ðŸ‡§ðŸ‡· +55</option>
            <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
            <option value="+34">ðŸ‡ªðŸ‡¸ +34</option>
            <option value="+44">ðŸ‡¬ðŸ‡§ +44</option>
            <option value="+33">ðŸ‡«ðŸ‡· +33</option>
            <option value="+39">ðŸ‡®ðŸ‡¹ +39</option>
            <option value="+49">ðŸ‡©ðŸ‡ª +49</option>
          </select>
          <input name="numero" type="tel" placeholder="NÃºmero de telÃ©fono" minlength="9" required inputmode="numeric" style="padding:12px;border:1px solid var(--border);border-radius:8px;flex:1" />
        </div>
        <select name="modelo" style="padding:12px;border:1px solid var(--border);border-radius:8px">
          <option value="">Modelo</option>
          {Array.from(new Set(planes.map(p=>p.modelo))).map(m=> <option selected={defaultModel===m}>{m}</option>)}
        </select>
        <select name="planTipo" style="padding:12px;border:1px solid var(--border);border-radius:8px">
          <option value="">Tipo de Plan (Opcional)</option>
          <option value="Plan 70% financiado">Plan 70% financiado</option>
          <option value="Plan 90% financiado">Plan 90% financiado</option>
        </select>
        <select name="provincia" style="padding:12px;border:1px solid var(--border);border-radius:8px">
          <option value="">Zona</option>
          <option value="Capital Federal">Capital Federal</option>
          <option value="GBA Norte">GBA Norte</option>
          <option value="GBA Oeste">GBA Oeste</option>
          <option value="GBA Sur">GBA Sur</option>
          <option value="Buenos Aires">Buenos Aires</option>
          <option value="Catamarca">Catamarca</option>
          <option value="CÃ³rdoba">CÃ³rdoba</option>
          <option value="Corrientes">Corrientes</option>
          <option value="Chaco">Chaco</option>
          <option value="Chubut">Chubut</option>
          <option value="Entre RÃ­os">Entre RÃ­os</option>
          <option value="Formosa">Formosa</option>
          <option value="Jujuy">Jujuy</option>
          <option value="La Pampa">La Pampa</option>
          <option value="La Rioja">La Rioja</option>
          <option value="Mendoza">Mendoza</option>
          <option value="Misiones">Misiones</option>
          <option value="NeuquÃ©n">NeuquÃ©n</option>
          <option value="RÃ­o Negro">RÃ­o Negro</option>
          <option value="Salta">Salta</option>
          <option value="San Juan">San Juan</option>
          <option value="San Luis">San Luis</option>
          <option value="Santa Fe">Santa Fe</option>
          <option value="Santa Cruz">Santa Cruz</option>
          <option value="Santiago del Estero">Santiago del Estero</option>
          <option value="Tierra del Fuego">Tierra del Fuego</option>
          <option value="TucumÃ¡n">TucumÃ¡n</option>
        </select>
        
        <textarea name="consulta" rows="4" placeholder="Consulta" class="full" style="padding:12px;border:1px solid var(--border);border-radius:8px"></textarea>
      </div>
      <div class="form-error" aria-live="polite"></div>
      <div class="form-success" aria-live="polite" style="display:none;background:#d1e7dd;color:#0f5132;border:1px solid #badbcc;padding:12px;border-radius:8px;margin-top:12px"></div>
      <div style="margin-top:12px"><button class="btn" style="background:#0d6efd;color:#fff;padding:14px 18px;font-size:16px;border-radius:12px;min-height:48px;width:100%;cursor:pointer" type="submit">Enviar</button></div>
      <div class="whatsapp-fallback" style="display:none"></div>
    </form>
  </div>
</section>
<script define:vars={{ WHATSAPP_PHONE }}>
  const form = document.querySelector('.contact-form');
  const err = document.querySelector('.form-error');
  const fallback = document.querySelector('.whatsapp-fallback');
  const success = document.querySelector('.form-success');
  const modelSelect = form?.querySelector('select[name="modelo"]');
  const planTipoSelect = form?.querySelector('select[name="planTipo"]');
  const provinciaSelect = form?.querySelector('select[name="provincia"]');
  const consultaArea = form?.querySelector('textarea[name="consulta"]');
  function prefillFromQuery(){
    const params = new URLSearchParams(location.search);
    const qModel = params.get('modelo');
    const qPlan = params.get('plan');
    if(qModel && modelSelect){
      const opt = Array.from(modelSelect.options).find(o=>o.value===qModel || o.text===qModel);
      if(opt){ modelSelect.value = opt.value || qModel; }
      if(consultaArea){ consultaArea.value = `Me gustarÃ­a recibir informaciÃ³n sobre ${qModel}`; }
    }
    if(qPlan && planTipoSelect){
      const opt = Array.from(planTipoSelect.options).find(o=>o.value===qPlan || o.text===qPlan);
      if(opt){ planTipoSelect.value = opt.value || qPlan; }
    }
  }
  prefillFromQuery();
  form?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const data = new FormData(form);
    const nombre = (data.get('nombre')||'').toString().trim();
    const codigoPais = (data.get('codigoPais')||'').toString().trim();
    const numero = (data.get('numero')||'').toString().trim();
    const consulta = (data.get('consulta')||'').toString().trim();
    const modelo = (data.get('modelo')||'').toString().trim();
    const planTipo = (data.get('planTipo')||'').toString().trim();
    const provincia = (data.get('provincia')||'').toString().trim();
    if(!nombre){ if(err) err.textContent = 'CompletÃ¡ tu nombre y apellido.'; return; }
    const numDigits = numero.replace(/\D/g,'').length;
    if(!numero || numDigits < 9){ if(err) err.textContent = 'IngresÃ¡ tu nÃºmero de telÃ©fono (mÃ­nimo 9 dÃ­gitos).'; return; }
    const mensaje = `Hola! Quiero info de FIAT por plan\nNombre y Apellido: ${nombre}${numero?`\nNÃºmero: ${codigoPais?codigoPais+' ':''}${numero}`:''}${modelo?`\nModelo: ${modelo}`:''}${planTipo?`\nTipo de Plan: ${planTipo}`:''}${provincia?`\nLugar: ${provincia}`:''}\nConsulta: ${consulta}`;
    const url = `https://api.whatsapp.com/send?phone=${WHATSAPP_PHONE}&text=${encodeURIComponent(mensaje)}`;
    if(err) err.textContent = '';
    if(success){ success.style.display = 'none'; success.textContent = ''; }
    try{
      const res = await fetch('https://formsubmit.co/ajax/francobusch130@gmail.com', { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify({ nombre, codigoPais, numero, modelo, planTipo, provincia, consulta }) });
      if(success){ success.textContent = 'Â¡Consulta enviada! Nos pondremos en contacto a la brevedad.'; success.style.display = 'block'; }
    }catch(_){ if(success){ success.textContent = 'Â¡Consulta enviada! Nos pondremos en contacto a la brevedad.'; success.style.display = 'block'; } }
    try{ const win = window.open(url, '_blank'); if(!win && fallback){ fallback.innerHTML = `<a href="${url}">Abrir WhatsApp</a>`; fallback.style.display = 'block'; } }
    catch(_){ if(fallback){ fallback.innerHTML = `<a href="${url}">Abrir WhatsApp</a>`; fallback.style.display = 'block'; } }
  });
</script>
