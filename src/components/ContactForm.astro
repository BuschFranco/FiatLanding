---
import { planes } from "../data/planes";
const { defaultModel = "", availablePercents = undefined } = Astro.props;
const unionPercents = (() => {
  if (Array.isArray(availablePercents)) return Array.from(new Set(availablePercents)).sort((a,b)=>a-b);
  const all = planes.flatMap(p => (p.planPercentsVisible ?? p.planPercents ?? []));
  return Array.from(new Set(all)).sort((a,b)=>a-b);
})();
---
<section id="contacto" class="section">
  <div class="container contact-wrap">
    <h2 class="section-title">Contacto</h2>
    <form class="contact-form">
      <div class="form-grid">
        <input name="nombre" type="text" placeholder="Nombre y Apellido" style="padding:12px;border:1px solid var(--border);border-radius:8px" />
        <div class="phone-row" style="display:flex;gap:8px;align-items:center">
          <input name="numero" type="tel" placeholder="Número de teléfono" minlength="10" maxlength="11" required inputmode="numeric" style="padding:12px;border:1px solid var(--border);border-radius:8px;flex:1" />
        </div>
        <div>
          <label for="anticipo" style="display:block;margin-bottom:6px;font-weight:600;font-size:13px">Anticipo (Opcional)</label>
          <input id="anticipo" name="anticipo" type="text" placeholder="Auto usado, valor monetario, etc" style="padding:12px;border:1px solid var(--border);border-radius:8px;width:100%" />
        </div>
        <div>
          <label for="valorCuota" style="display:block;margin-bottom:6px;font-weight:600;font-size:13px">Valor cuota (Opcional)</label>
          <input id="valorCuota" name="valorCuota" type="text" placeholder="Valor de cuota dispuesto a invertir" style="padding:12px;border:1px solid var(--border);border-radius:8px;width:100%" />
        </div>
        <select name="modelo" style="padding:12px;border:1px solid var(--border);border-radius:8px">
          <option value="">Modelo</option>
          {Array.from(new Set(planes.map(p=>p.modelo))).map(m=> <option selected={defaultModel===m}>{m}</option>)}
        </select>
        <select name="planTipo" style="padding:12px;border:1px solid var(--border);border-radius:8px">
          <option value="">Tipo de Plan (Opcional)</option>
          {unionPercents.map(pct => (
            <option value={`Plan ${pct}% financiado`}>Plan {pct}% financiado</option>
          ))}
        </select>
        <select name="provincia" style="padding:12px;border:1px solid var(--border);border-radius:8px">
          <option value="">Zona</option>
          <option value="Capital Federal">Capital Federal</option>
          <option value="GBA Norte">GBA Norte</option>
          <option value="GBA Oeste">GBA Oeste</option>
          <option value="GBA Sur">GBA Sur</option>
          <option value="Buenos Aires">Buenos Aires</option>
          <option value="Catamarca">Catamarca</option>
          <option value="Córdoba">Córdoba</option>
          <option value="Corrientes">Corrientes</option>
          <option value="Chaco">Chaco</option>
          <option value="Chubut">Chubut</option>
          <option value="Entre Ríos">Entre Ríos</option>
          <option value="Formosa">Formosa</option>
          <option value="Jujuy">Jujuy</option>
          <option value="La Pampa">La Pampa</option>
          <option value="La Rioja">La Rioja</option>
          <option value="Mendoza">Mendoza</option>
          <option value="Misiones">Misiones</option>
          <option value="Neuquén">Neuquén</option>
          <option value="Río Negro">Río Negro</option>
          <option value="Salta">Salta</option>
          <option value="San Juan">San Juan</option>
          <option value="San Luis">San Luis</option>
          <option value="Santa Fe">Santa Fe</option>
          <option value="Santa Cruz">Santa Cruz</option>
          <option value="Santiago del Estero">Santiago del Estero</option>
          <option value="Tierra del Fuego">Tierra del Fuego</option>
          <option value="Tucumán">Tucumán</option>
        </select>
        
        <textarea name="consulta" rows="4" placeholder="Consulta" class="full" style="padding:12px;border:1px solid var(--border);border-radius:8px"></textarea>
      </div>
      <div class="form-error" aria-live="polite"></div>
      <div class="form-success" aria-live="polite" style="display:none;background:#d1e7dd;color:#0f5132;border:1px solid #badbcc;padding:12px;border-radius:8px;margin-top:12px"></div>
      <div style="margin-top:12px"><button class="btn submit-btn" style="background:#0d6efd;color:#fff;padding:14px 18px;font-size:16px;border-radius:12px;min-height:48px;width:100%;cursor:pointer;position:relative" type="submit"><span class="btn-label">Enviar</span><span class="btn-loader" aria-hidden="true" style="display:none;width:16px;height:16px;border:2px solid rgba(255,255,255,0.35);border-top-color:#fff;border-radius:50%;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);animation:spin .8s linear infinite"></span></button></div>
    </form>
  </div>
</section>
<script>
  const form = document.querySelector('.contact-form');
  const err = document.querySelector('.form-error');
  const success = document.querySelector('.form-success');
  const submitBtn = form?.querySelector('.submit-btn');
  const submitLabel = submitBtn?.querySelector('.btn-label');
  const submitLoader = submitBtn?.querySelector('.btn-loader');
  const nombreInput = form?.querySelector('input[name="nombre"]');
  const numeroInput = form?.querySelector('input[name="numero"]');
  const anticipoInput = form?.querySelector('input[name="anticipo"]');
  const valorCuotaInput = form?.querySelector('input[name="valorCuota"]');
  const modelSelect = form?.querySelector('select[name="modelo"]');
  const planTipoSelect = form?.querySelector('select[name="planTipo"]');
  const provinciaSelect = form?.querySelector('select[name="provincia"]');
  const consultaArea = form?.querySelector('textarea[name="consulta"]');
  function prefillFromQuery(){
    const params = new URLSearchParams(location.search);
    const qModel = params.get('modelo');
    const qPlan = params.get('plan');
    if(qModel && modelSelect){
      const opt = Array.from(modelSelect.options).find(o=>o.value===qModel || o.text===qModel);
      if(opt){ modelSelect.value = opt.value || qModel; }
      if(consultaArea){ consultaArea.value = `Me gustaría recibir información sobre ${qModel}`; }
    }
    if(qPlan && planTipoSelect){
      const opt = Array.from(planTipoSelect.options).find(o=>o.value===qPlan || o.text===qPlan);
      if(opt){ planTipoSelect.value = opt.value || qPlan; }
    }
  }
  prefillFromQuery();
  form?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const data = new FormData(form);
    const nombre = (data.get('nombre')||'').toString().trim();
    const numero = (data.get('numero')||'').toString().trim();
    const consulta = (data.get('consulta')||'').toString().trim();
    const anticipo = (data.get('anticipo')||'').toString().trim();
    const valorCuota = (data.get('valorCuota')||'').toString().trim();
    const modelo = (data.get('modelo')||'').toString().trim();
    const planTipo = (data.get('planTipo')||'').toString().trim();
    const provincia = (data.get('provincia')||'').toString().trim();
    if(!nombre){ if(err) err.textContent = 'Completá tu nombre y apellido.'; return; }
    const numDigits = numero.replace(/\D/g,'').length;
    if(!numero || numDigits < 9){ if(err) err.textContent = 'Ingresá tu número de teléfono (mínimo 9 dígitos).'; return; }
    const mensaje = `Hola! Quiero info de FIAT por plan\nNombre y Apellido: ${nombre}${numero?`\nNúmero: ${numero}`:''}${modelo?`\nModelo: ${modelo}`:''}${planTipo?`\nTipo de Plan: ${planTipo}`:''}${provincia?`\nLugar: ${provincia}`:''}${anticipo?`\nAnticipo: ${anticipo}`:''}${valorCuota?`\nValor cuota: ${valorCuota}`:''}\nConsulta: ${consulta}`;
    if(err) err.textContent = '';
    if(success){ success.style.display = 'none'; success.textContent = ''; }
    if(submitBtn){ submitBtn.disabled = true; submitBtn.setAttribute('aria-busy','true'); }
    if(submitLabel){ submitLabel.style.opacity = '0'; }
    if(submitLoader){ submitLoader.style.display = 'inline-block'; submitBtn?.classList.add('loading'); }
    try{
      const res = await fetch('https://formsubmit.co/ajax/francobusch130@gmail.com', { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify({ nombre, numero, modelo, planTipo, provincia, consulta, anticipo, valorCuota }) });
      if(res && res.ok){
        if(success){ success.textContent = '¡Consulta enviada! Nos pondremos en contacto a la brevedad.'; success.style.display = 'block'; }
        try{ if(typeof window.gtag_report_conversion === 'function'){ window.gtag_report_conversion(); } }catch(_){ }
        if(submitBtn){ submitBtn.disabled = false; submitBtn.removeAttribute('aria-busy'); }
        if(submitLabel){ submitLabel.style.opacity = '1'; }
        if(submitLoader){ submitLoader.style.display = 'none'; submitBtn?.classList.remove('loading'); }
        if(nombreInput){ nombreInput.value = ''; }
        if(numeroInput){ numeroInput.value = ''; }
        if(anticipoInput){ anticipoInput.value = ''; }
        if(valorCuotaInput){ valorCuotaInput.value = ''; }
        if(modelSelect){ modelSelect.value = ''; }
        if(planTipoSelect){ planTipoSelect.value = ''; }
        if(provinciaSelect){ provinciaSelect.value = ''; }
        if(consultaArea){ consultaArea.value = ''; }
      } else {
        if(submitBtn){ submitBtn.disabled = false; submitBtn.removeAttribute('aria-busy'); }
        if(submitLabel){ submitLabel.style.opacity = '1'; }
        if(submitLoader){ submitLoader.style.display = 'none'; submitBtn?.classList.remove('loading'); }
      }
    }catch(_){ 
      if(submitBtn){ submitBtn.disabled = false; submitBtn.removeAttribute('aria-busy'); }
      if(submitLabel){ submitLabel.style.opacity = '1'; }
      if(submitLoader){ submitLoader.style.display = 'none'; submitBtn?.classList.remove('loading'); }
    }
  });
</script>
