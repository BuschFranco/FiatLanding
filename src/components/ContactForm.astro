---
import { planes } from "../data/planes";
const { defaultModel = "" } = Astro.props;
const clientEmail = import.meta.env.PUBLIC_CLIENT_EMAIL;
---
<section id="contacto" class="section">
  <div class="container contact-wrap">
    <h2 class="section-title">Contacto</h2>
    <form class="contact-form">
      <div class="form-grid">
        <input name="nombre" type="text" placeholder="Nombre y Apellido" style="padding:12px;border:1px solid var(--border);border-radius:8px" />
        <div class="phone-row" style="display:flex;gap:8px;align-items:center">
          <input name="numero" type="tel" placeholder="Número de teléfono" minlength="10" maxlength="11" required inputmode="numeric" style="padding:12px;border:1px solid var(--border);border-radius:8px;flex:1" />
        </div>
        <select name="modelo" style="padding:12px;border:1px solid var(--border);border-radius:8px">
          <option value="">Modelo</option>
          {Array.from(new Set(planes.map(p=>p.modelo))).map(m=> <option selected={defaultModel===m}>{m}</option>)}
          <option value="Argo">Argo</option>
          <option value="Pulse">Pulse</option>
          <option value="Strada">Strada</option>
          <option value="Fiorino">Fiorino</option>
          <option value="Doblò">Doblò</option>
          <option value="500">500</option>
          <option value="500e">500e</option>
          <option value="500X">500X</option>
          <option value="Siena">Siena</option>
          <option value="Palio">Palio</option>
          <option value="Idea">Idea</option>
          <option value="Punto">Punto</option>
          <option value="Linea">Linea</option>
          <option value="Bravo">Bravo</option>
          <option value="Uno">Uno</option>
          <option value="Toro">Toro</option>
        </select>
        
        
        <textarea name="consulta" rows="4" placeholder="Consulta" class="full" style="padding:12px;border:1px solid var(--border);border-radius:8px"></textarea>
      </div>
      <div class="form-error" aria-live="polite"></div>
      <div class="form-success" aria-live="polite" style="display:none;background:#d1e7dd;color:#0f5132;border:1px solid #badbcc;padding:12px;border-radius:8px;margin-top:12px"></div>
      <div style="margin-top:12px"><button class="btn submit-btn pulse-soft" style="background:#0d6efd;color:#fff;padding:14px 18px;font-size:16px;border-radius:12px;min-height:48px;width:100%;cursor:pointer;position:relative" type="submit"><span class="btn-label">¡Obtené tu descuento ahora! </span><span class="btn-loader" aria-hidden="true" style="display:none;width:16px;height:16px;border:2px solid rgba(255,255,255,0.35);border-top-color:#fff;border-radius:50%;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);animation:spin .8s linear infinite"></span></button></div>
    </form>
  </div>
</section>
<script>
  const form = document.querySelector('.contact-form');
  const err = document.querySelector('.form-error');
  const success = document.querySelector('.form-success');
  const submitBtn = form?.querySelector('.submit-btn');
  const submitLabel = submitBtn?.querySelector('.btn-label');
  const submitLoader = submitBtn?.querySelector('.btn-loader');
  const nombreInput = form?.querySelector('input[name="nombre"]');
  const numeroInput = form?.querySelector('input[name="numero"]');
  // campos opcionales removidos
  const modelSelect = form?.querySelector('select[name="modelo"]');
  // removidos: planTipoSelect, provinciaSelect
  const consultaArea = form?.querySelector('textarea[name="consulta"]');
  function prefillFromQuery(){
    const params = new URLSearchParams(location.search);
    const qModel = params.get('modelo');
    // removidos: qPlan y prefill de plan
    if(qModel && modelSelect){
      const opt = Array.from(modelSelect.options).find(o=>o.value===qModel || o.text===qModel);
      if(opt){ modelSelect.value = opt.value || qModel; }
      if(consultaArea){ consultaArea.value = `Me gustaría recibir información sobre ${qModel}`; }
    }
    // sin prefill de plan
  }
  prefillFromQuery();
  form?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const data = new FormData(form);
    const nombre = (data.get('nombre')||'').toString().trim();
    const numero = (data.get('numero')||'').toString().trim();
    const consulta = (data.get('consulta')||'').toString().trim();
    // opcionales removidos
    const modelo = (data.get('modelo')||'').toString().trim();
    // removidos: planTipo y provincia
    if(!nombre){ if(err) err.textContent = 'Completá tu nombre y apellido.'; return; }
    const numDigits = numero.replace(/\D/g,'').length;
    if(!numero || numDigits < 9){ if(err) err.textContent = 'Ingresá tu número de teléfono (mínimo 9 dígitos).'; return; }
    if(err) err.textContent = '';
    if(success){ success.style.display = 'none'; success.textContent = ''; }
    if(submitBtn){ submitBtn.disabled = true; submitBtn.setAttribute('aria-busy','true'); }
    if(submitLabel){ submitLabel.style.opacity = '0'; }
    if(submitLoader){ submitLoader.style.display = 'inline-block'; submitBtn?.classList.add('loading'); }
    try{
      const res = await fetch('https://formsubmit.co/ajax/dalealoliveros@gmail.com', { method:'POST', headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, body: JSON.stringify({ nombre, numero, modelo, consulta }) });
      if(res && res.ok){
        if(success){ success.textContent = '¡Consulta enviada! Nos pondremos en contacto a la brevedad.'; success.style.display = 'block'; }
        window.location.href = '/gracias';
      } else {
        if(submitBtn){ submitBtn.disabled = false; submitBtn.removeAttribute('aria-busy'); }
        if(submitLabel){ submitLabel.style.opacity = '1'; }
        if(submitLoader){ submitLoader.style.display = 'none'; submitBtn?.classList.remove('loading'); }
      }
    }catch(_){ 
      if(submitBtn){ submitBtn.disabled = false; submitBtn.removeAttribute('aria-busy'); }
      if(submitLabel){ submitLabel.style.opacity = '1'; }
      if(submitLoader){ submitLoader.style.display = 'none'; submitBtn?.classList.remove('loading'); }
    }
  });
</script>
