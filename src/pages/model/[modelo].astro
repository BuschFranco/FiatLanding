---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { planes } from "../../data/planes";
import ContactForm from "../../components/ContactForm.astro";
export function getStaticPaths() {
  return planes.map(p=>({ params: { modelo: p.slug }, props: { data: p } }));
}
const { data } = Astro.props;
---
<BaseLayout title={data ? `FIAT ${data.modelo}` : "Modelo FIAT"}>
  <section class="section">
    <div class="container">
      {data ? (
        <>
          <h1 class="section-title">Plan de ahorro <span class="highlight">FIAT {data.modelo}</span></h1>
          <div class="model-top">
            {data.img && <div class="image" style="border-radius:12px;overflow:hidden;background:#fbe9ea"><img src={data.img} alt={`FIAT ${data.modelo}`} style="width:100%;display:block" loading="lazy" /></div>}
            <div>
              <div class="tabs">
                <div class="tabs-left">
                  {(data.planPercentsVisible ?? data.planPercents ?? [70,90]).map((p, idx)=> (
                    <button class={`tab ${idx===0?'active':''}`} data-percent={p}>Plan {p}% financiado</button>
                  ))}
                </div>
                {data.img && <div class="image-mini"><img src={data.img} alt={`FIAT ${data.modelo}`} loading="lazy" /></div>}
              </div>
              <div id="prices" class="card">
                <div class="prices-grid">
                  <div class="card price-card" style="margin:0">
                    <div class="model">cuota desde</div>
                    <div class="price" id="cuota-desde">$0</div>
                  </div>
                  <div class="card price-card" style="margin:0">
                    <div class="model">cuota pura</div>
                    <div class="price" id="cuota-pura">$0</div>
                  </div>
                </div>
                <div class="detail">Anticipo: <span id="anticipo">Consultar</span></div>
                <div class="detail">Precio vehículo</div>
                <div class="price" id="precio-vehiculo">$0</div>
                <div class="detail" style="margin-top:8px">Consulta sin compromiso. Un asesor oficial se comunicará con vos.</div>
              </div>
              <div class="cta" style="margin-top:12px">
                <a class="btn" style="background:var(--primary);color:#fff;width:100%" href="#contacto" data-model={data.modelo}>Solicitar asesor FIAT</a>
              </div>
            </div>
          </div>
          
          <script define:vars={{ PRICE: data.precioVehiculo ?? 30000000, PRICE_CFG: { cuotas: data.cuotas ?? 84, adminFactor: data.adminFactor ?? 1.2, percents: (data.planPercentsVisible ?? data.planPercents ?? [70,90]) }, CUOTA_DESDE_MAP: data.cuotaDesdePorPlan ?? {}, ANTICIPO_MAP: data.anticipoPorPlan ?? {}, DETALLE_MAP: data.detalleCuotasPorPlan ?? {}, DETALLE_DEFAULT: data.detalleCuotas ?? [] }}>
            const CUOTAS = PRICE_CFG?.cuotas ?? 84;
            const ADMIN_FACTOR = PRICE_CFG?.adminFactor ?? 1.2;
            const fmt = (n)=> new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(n);
            const parseARS = (str)=>{ try{ return parseInt(String(str).replace(/[^0-9]/g,'')||'0',10) }catch(_){ return 0 } };
            window.planSelectedByUser = false;
            function chooseInitialPercent(){
              try {
                const percents = Array.isArray(PRICE_CFG?.percents) ? PRICE_CFG.percents : [];
                const candidates = percents.map((pct)=>({ pct, val: parseARS(CUOTA_DESDE_MAP?.[pct]) })).filter(x=> x.val > 0);
                if (candidates.length === 0) return percents.length ? percents[0] : 70;
                candidates.sort((a,b)=> a.val - b.val);
                return candidates[0].pct;
              } catch(_) { return 70; }
            }
            function update(percent){
              const financed = PRICE * (percent/100);
              const override = CUOTA_DESDE_MAP && CUOTA_DESDE_MAP[percent] ? CUOTA_DESDE_MAP[percent] : "";
              if(override && override.length){
                const desdeNum = parseARS(override);
                const puraNum = Math.round(desdeNum / ADMIN_FACTOR);
                document.getElementById('cuota-pura').textContent = fmt(puraNum);
                document.getElementById('cuota-desde').textContent = override;
              } else {
                const pura = Math.round(financed / CUOTAS);
                const desde = Math.round(pura * ADMIN_FACTOR);
                document.getElementById('cuota-pura').textContent = fmt(pura);
                document.getElementById('cuota-desde').textContent = fmt(desde);
              }
              const anticipoOverride = ANTICIPO_MAP && ANTICIPO_MAP[percent] ? ANTICIPO_MAP[percent] : "";
              document.getElementById('anticipo').textContent = anticipoOverride && anticipoOverride.length ? anticipoOverride : 'Consultar';
              document.getElementById('precio-vehiculo').textContent = fmt(PRICE);
            }
            function renderDetalle(percent){
              try {
                const fallback = [
                  { label: "Cuota 1", value: "Consultar" },
                  { label: "Cuotas 2 a 13", value: "Consultar" },
                  { label: "Cuotas 14 a 18", value: "Consultar" },
                  { label: "Cuotas 19 a 42", value: "Consultar" },
                  { label: "Cuotas 43 a 84", value: "Consultar" },
                  { label: "Alicuota extraordinaria", value: "Consultar" }
                ];
                const computed = (DETALLE_MAP && DETALLE_MAP[percent]) ? DETALLE_MAP[percent] : DETALLE_DEFAULT;
                const list = Array.isArray(computed) && computed.length ? computed : fallback;
                const host = document.getElementById('detalle-cuotas');
                if (host) {
                  host.innerHTML = Array.isArray(list) ? list.map(i=>`<div class="detail">${i.label}: ${i.value}</div>`).join('') : '';
                }
              } catch(_){}
            }
            const initial = chooseInitialPercent();
            update(initial);
            renderDetalle(initial);
            (function(){
              const tabs = document.querySelectorAll('.tab');
              tabs.forEach(b=> b.classList.remove('active'));
              const match = Array.from(tabs).find(b=> parseInt(b.dataset.percent,10) === initial);
              match?.classList.add('active');
            })();
            document.querySelectorAll('.tab').forEach(t=>{
              t.addEventListener('click',()=>{
                const prices = document.getElementById('prices');
                document.querySelectorAll('.tab').forEach(b=> b.classList.remove('active'));
                t.classList.add('active');
                prices?.classList.add('switching');
                const percent = parseInt(t.dataset.percent,10);
                setTimeout(()=>{
                  update(percent);
                  renderDetalle(percent);
                  prices?.classList.remove('switching');
                  const planSelect = document.querySelector('.contact-form select[name="planTipo"]');
                  const planStr = `Plan ${percent}% financiado`;
                  if(planSelect){ planSelect.value = planStr; }
                  window.planSelectedByUser = true;
                }, 140);
              });
            });
          </script>
          <script>
            document.addEventListener('DOMContentLoaded', ()=>{
              document.querySelectorAll('a[data-model]')?.forEach(btn=>{
                btn.addEventListener('click',(e)=>{
                  const model = btn.getAttribute('data-model') || '';
                  const form = document.querySelector('.contact-form');
                  const contactSection = document.getElementById('contacto');
                  const modelSelect = form?.querySelector('select[name="modelo"]');
                  const planTipoSelect = form?.querySelector('select[name="planTipo"]');
                  const consultaArea = form?.querySelector('textarea[name="consulta"]');
                  if(form && contactSection){
                    e.preventDefault();
                    if(modelSelect){
                      const opt = Array.from(modelSelect.options).find(o=>o.value===model || o.text===model);
                      if(opt){ modelSelect.value = opt.value || model; }
                    }
                    if(consultaArea){ consultaArea.value = `Me gustaría recibir información sobre ${model}`; }
                    const activeTab = document.querySelector('.tab.active');
                    const planStr = activeTab ? `Plan ${activeTab.dataset.percent}% financiado` : '';
                    if(window.planSelectedByUser && planStr && planTipoSelect){ planTipoSelect.value = planStr; }
                    contactSection.scrollIntoView({behavior:'smooth', block:'start'});
                    const wrap = form.closest('.container');
                    wrap?.classList.add('contact-pulse');
                    setTimeout(()=>{ wrap?.classList.remove('contact-pulse'); }, 1600);
                  }
                });
              });
            });
          </script>
          {data.specs && (
            <div class="card" style="margin-bottom:16px">
              <div class="model">Especificaciones técnicas</div>
              <div class="detail">Motor: {data.specs.motor}</div>
              <div class="detail">Potencia: {data.specs.potencia}</div>
              <div class="detail">Torque: {data.specs.torque}</div>
              <div class="detail">Transmisión: {data.specs.transmision}</div>
              <div class="detail">Tracción: {data.specs.traccion}</div>
              {data.specs.dim && <div class="detail">Dimensiones: {data.specs.dim}</div>}
            </div>
          )}
          <div class="details-grid">
            <div class="card">
              <div class="model">Características del plan de ahorro FIAT {data.modelo}</div>
              <div class="detail">El plan financia un porcentaje del vehículo en 84 cuotas. El resto se licita o se abona al momento de la adjudicación.</div>
              <ul class="bullets" style="margin:12px 0 0 16px">
                <li>Licitar a partir de la segunda cuota.</li>
                <li>Participás del sorteo de adjudicación.</li>
                <li>Cuotas con gastos administrativos incluidos.</li>
                <li>Evaluamos la toma de tu usado.</li>
                <li>Adelanto de cuotas puras.</li>
                <li>Bonificación por débito automático.</li>
              </ul>
              <div style="margin-top:12px;background:var(--primary);color:#fff;padding:10px 12px;border-radius:8px;font-weight:700">Entregas aseguradas cuotas 4/9/12/24/36</div>
            </div>
            <div class="card">
              <div class="model">Detalle de cuotas</div>
              <div id="detalle-cuotas">
                {((data.detalleCuotas) ?? [
                  { label: "Cuota 1", value: "Consultar" },
                  { label: "Cuotas 2 a 13", value: "Consultar" },
                  { label: "Cuotas 14 a 18", value: "Consultar" },
                  { label: "Cuotas 19 a 42", value: "Consultar" },
                  { label: "Cuotas 43 a 84", value: "Consultar" },
                  { label: "Alicuota extraordinaria", value: "Consultar" }
                ]).map(item => (
                  <div class="detail">{item.label}: {item.value}</div>
                ))}
              </div>
            </div>
          </div>
          <div class="card" style="margin-bottom:16px">
            <div class="model">Medios de pago</div>
            <div class="detail">Transferencia bancaria, débito automático, tarjetas (Visa, MasterCard, Amex), Rapipago, PagoMisCuentas.</div>
          </div>
          <div class="cta" style="display:flex;gap:12px">
            <a class="btn" style="background:var(--primary);color:#fff;width:100%" href="#contacto" data-model={data.modelo}>Solicitar asesor FIAT</a>
            <a class="btn btn-outline" href="/">Volver</a>
          </div>
        </>
      ) : (
        <>
          <h1 class="section-title">Modelo no encontrado</h1>
          <a class="btn btn-outline" href="/">Volver</a>
        </>
      )}
    </div>
  </section>
  
  {data && <ContactForm defaultModel={data.modelo} availablePercents={data.planPercentsVisible ?? data.planPercents} />}
</BaseLayout>
