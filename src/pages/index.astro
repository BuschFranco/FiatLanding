---
import BaseLayout from "../layouts/BaseLayout.astro";
import { WHATSAPP_PHONE } from "../config";
import { planes } from "../data/planes";
import ContactForm from "../components/ContactForm.astro";
const parseARS = (str)=>{ try{ return parseInt(String(str||'').replace(/[^0-9]/g,''),10) || 0 }catch(_){ return 0 } };
const lowestCuotaDesde = (p)=>{
  const percents = Array.isArray(p.planPercentsVisible) ? p.planPercentsVisible : (p.planPercents ?? []);
  const map = p.cuotaDesdePorPlan ?? {};
  const candidates = percents.map((pct)=>({ pct, valStr: map?.[pct], valNum: parseARS(map?.[pct]) })).filter(x=> x.valNum > 0);
  if(candidates.length === 0) return p.precio ?? "";
  candidates.sort((a,b)=> a.valNum - b.valNum);
  return candidates[0].valStr || p.precio || "";
};
---
<BaseLayout title="Portuauto | Planes FIAT">
  <section class="hero">
    <div class="container inner">
      <div>
        <h1>Planes <span class="highlight">FIAT</span> de ahorro hasta <span class="highlight">90%</span> financiados</h1>
        <p style="border-radius: 8px; padding: 8px 16px; background-color: rgba(255, 255, 255, 0.87); color:black;">Accedé a tu <span class="highlight">FIAT 0 km</span> con cuotas accesibles y financiación oficial.</p>
        <div class="cta">
          <a href="#planes" class="btn btn-primary">Ver planes</a>
          <a href="#contacto" class="btn btn-secondary">Asesoría</a>
        </div>
        <div class="stats">
          <div class="stat"><div class="value">+20</div><div class="label">Modelos</div></div>
          <div class="stat"><div class="value">90%</div><div class="label">Financiados</div></div>
          <div class="stat"><div class="value">Hasta 84</div><div class="label">Cuotas</div></div>
        </div>
      </div>
      
    </div>
  </section>
  <section id="planes" class="section">
    <div class="container">
      <h2 class="section-title">Planes FIAT disponibles</h2>
      <div class="cards">
        {planes.map((p)=> (
          <article class="card">
            {p.img && <div class="image"><img src={p.img} alt={`FIAT ${p.modelo}`} loading="lazy" /></div>}
            <div class="brand">Plan {p.marca}</div>
            <div class="price">Cuotas desde {lowestCuotaDesde(p)}</div>
            <div class="model">{p.modelo}</div>
            {p.version && <div class="detail">{p.version}</div>}
            <div class="detail">{p.financiamiento}</div>
            <div class="actions">
              <a class="btn" href="#contacto" data-model={p.modelo}>Solicitar asesor FIAT</a>
              <a class="btn btn-outline" href={`/model/${p.slug}`}>Más información</a>
            </div>
          </article>
        ))}
      </div>
    </div>
  </section>
  <ContactForm />
  <script define:vars={{ WHATSAPP_PHONE }}>
    const form = document.querySelector('.contact-form');
    const err = document.querySelector('.form-error');
    const fallback = document.querySelector('.whatsapp-fallback');
    const contactSection = document.getElementById('contacto');
    const modelSelect = form?.querySelector('select[name="modelo"]');
    const consultaArea = form?.querySelector('textarea[name="consulta"]');
    function isEmail(v){ return /.+@.+\..+/.test(v); }
    function digits(v){ return (v||'').replace(/\D+/g,''); }
    // envío manejado dentro del componente ContactForm

    document.querySelectorAll('.cards .actions .btn[data-model]')?.forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const target = e.currentTarget;
        const model = target.getAttribute('data-model') || target.closest('.card')?.querySelector('.model')?.textContent || '';
        if(modelSelect){
          const opt = Array.from(modelSelect.options).find(o=>o.value===model || o.text===model);
          if(opt){ modelSelect.value = opt.value || model; } else { modelSelect.value = ''; }
        }
        if(consultaArea){
          const base = `Me gustaría recibir información sobre ${model}`;
          consultaArea.value = base;
        }
        contactSection?.scrollIntoView({behavior:'smooth', block:'start'});
        const wrap = form?.closest('.container');
        wrap?.classList.add('contact-pulse');
        setTimeout(()=>{ wrap?.classList.remove('contact-pulse'); }, 1600);
      });
    });
    // prefill por query lo maneja ContactForm
</script>
</BaseLayout>
