---
import BaseLayout from "../layouts/BaseLayout.astro";
import { WHATSAPP_PHONE } from "../config";
import { planes } from "../data/planes";
import ContactForm from "../components/ContactForm.astro";
const parseARS = (str)=>{ try{ return parseInt(String(str||'').replace(/[^0-9]/g,''),10) || 0 }catch(_){ return 0 } };
const lowestCuotaDesde = (p)=>{
  const percents = Array.isArray(p.planPercentsVisible) ? p.planPercentsVisible : (p.planPercents ?? []);
  const map = p.cuotaDesdePorPlan ?? {};
  const candidates = percents.map((pct)=>({ pct, valStr: map?.[pct], valNum: parseARS(map?.[pct]) })).filter(x=> x.valNum > 0);
  if(candidates.length === 0) return p.precio ?? "";
  candidates.sort((a,b)=> a.valNum - b.valNum);
  return candidates[0].valStr || p.precio || "";
};
---
<BaseLayout title="Portuauto | Planes FIAT">
  <section class="hero">
    <div class="container inner">
      <div>
        <h1>Planes <span class="highlight">FIAT</span> de ahorro hasta <span class="highlight">90%</span> financiados</h1>
        <p style="border-radius: 8px; padding: 8px 16px; background-color: rgba(255, 255, 255, 0.87); color:black;">Accedé a tu <span class="highlight">FIAT 0 km</span> con cuotas accesibles y financiación oficial.</p>
        <div class="cta">
          <a href="#planes" class="btn btn-primary">Ver planes</a>
          <a href="#contacto" class="btn btn-secondary">Asesoría</a>
        </div>
        <div class="stats">
          <div class="stat"><div class="value">+20</div><div class="label">Modelos</div></div>
          <div class="stat"><div class="value">90%</div><div class="label">Financiados</div></div>
          <div class="stat"><div class="value">Hasta 84</div><div class="label">Cuotas</div></div>
        </div>
      </div>
      
    </div>
  </section>
  <section id="planes" class="section">
    <div class="container">
      <h2 class="section-title">Planes FIAT disponibles</h2>
      <div class="cards">
        {planes.map((p)=> (
          <article class="card">
            {p.img && <div class="image"><img src={p.img} alt={`FIAT ${p.modelo}`} loading="lazy" /></div>}
            <div class="brand">Plan {p.marca}</div>
            <div class="price">Cuotas desde {lowestCuotaDesde(p)}</div>
            <div class="model">{p.modelo}</div>
            {p.version && <div class="detail">{p.version}</div>}
            <div class="detail">{p.financiamiento}</div>
            <div class="actions">
              <a class="btn" href="#contacto" data-model={p.modelo}>Solicitar asesor FIAT</a>
              <a class="btn btn-outline" href={`/model/${p.slug}`}>Más información</a>
            </div>
          </article>
        ))}
      </div>
    </div>
  </section>
  <div id="contact-modal" role="dialog" aria-modal="true" style="position:fixed;inset:0;display:none;z-index:1200;display:none;align-items:center;justify-content:center;padding:16px">
    <div class="modal-backdrop" style="position:absolute;inset:0;background:rgba(0,0,0,0.45)"></div>
    <div class="modal-content" style="position:relative;width:100%;max-width:720px;max-height:calc(100vh - 32px);background:#fff;border-radius:12px;box-shadow:0 18px 40px rgba(0,0,0,0.35);padding:16px;z-index:1;overflow:auto;-webkit-overflow-scrolling:touch">
      <button class="modal-close" aria-label="Cerrar" title="Cerrar" style="position:absolute;top:8px;right:8px;background:#eee;color:#333;border:none;border-radius:999px;width:32px;height:32px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;line-height:1">×</button>
      <ContactForm />
    </div>
  </div>
  <script define:vars={{ WHATSAPP_PHONE }}>
    const modal = document.getElementById('contact-modal');
    const form = modal?.querySelector('.contact-form');
    const err = document.querySelector('.form-error');
    const fallback = document.querySelector('.whatsapp-fallback');
    const modelSelect = form?.querySelector('select[name="modelo"]');
    const consultaArea = form?.querySelector('textarea[name="consulta"]');
    function isEmail(v){ return /.+@.+\..+/.test(v); }
    function digits(v){ return (v||'').replace(/\D+/g,''); }
    // envío manejado dentro del componente ContactForm
    function openContactModal(){
      if(!modal) return;
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      const nombreInput = form?.querySelector('input[name="nombre"]');
      nombreInput?.focus();
    }
    function closeContactModal(){
      if(!modal) return;
      modal.style.display = 'none';
      document.body.style.overflow = '';
    }
    modal?.querySelector('.modal-close')?.addEventListener('click', (e)=>{ e.preventDefault(); closeContactModal(); });
    modal?.querySelector('.modal-backdrop')?.addEventListener('click', (e)=>{ e.preventDefault(); closeContactModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeContactModal(); } });

    document.querySelectorAll('.cards .actions .btn[data-model]')?.forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const target = e.currentTarget;
        const model = target.getAttribute('data-model') || target.closest('.card')?.querySelector('.model')?.textContent || '';
        if(modelSelect){
          const opt = Array.from(modelSelect.options).find(o=>o.value===model || o.text===model);
          if(opt){ modelSelect.value = opt.value || model; } else { modelSelect.value = ''; }
        }
        if(consultaArea){
          const base = `Me gustaría recibir información sobre ${model}`;
          consultaArea.value = base;
        }
        openContactModal();
      });
    });
    // prefill por query lo maneja ContactForm
</script>
</BaseLayout>
